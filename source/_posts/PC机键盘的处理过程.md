---
title: PC 机键盘的处理过程
date: 2021-05-13 18:34:49
update: 2021-05-13 18:34:49
urlname: pc-keyboard
tags:
  - Assembly
  - 8086
categories: Assembly
---

## 键盘输入

- 键盘上的每一个键相当于一个开关；
- 键盘中有一个芯片对键盘上的每一个键的开关状态进行扫描。

### 扫描码

- 按下（松开按下的）一个键时，开关接通（断开），芯片产生一个扫描码，长度为一个字节：说明了按下（松开）的键在键盘上的位置；
- 扫描码被送入主板上的相关接口芯片的寄存器中，该寄存器的端口地址为 60H。

分类：

- 通码：键按下产生的扫描码，第 7 位为 0；
- 断码：松开键产生的扫描码，第 7 位为 1。

断码 = 通码 + 80H

<!-- more -->

## 引发 9 号中断

键盘的输入到达 60H 端口 ---> 相关芯片向 CPU 发出中断类型码为 9 的可屏蔽中断信息。

## 执行 int9 中断例程

CPU 检测到 9 号中断，如果 IF = 1，则响应中断，引发中断过程，转去执行 int9 中断例程。

BIOS 提供了 int9 中断例程，用来进行基本的键盘输入处理，主要的工作如下：

1. 读出 60H 端口中的扫描码；
2. 如果是字符键的扫描码，将该扫描码和它所对应的字符码（即 ASCII 码）送入内存中的 BIOS 键盘缓冲区；
   如果是控制键（比如 Ctrl）和切换键（比如 CapsLock）的扫描码，则将其转变为状态字节写入内存中存储状态字节的单元；
3. 对键盘系统进行相关的控制（比如：向相关芯片发出应答信息）。

### BIOS 键盘缓冲区

系统启动后，BIOS 用于存放 int9 中断例程所接收的键盘输入的内存区。

该内存区可以存储 15 个键盘输入（扫描码+对应的字符码），一个键盘输入用一个字单元存放，高位字节存放扫描码，低位字节存放字符码。

### 状态字节

- 用二进制位记录控制键和切换键状态的字节；
- 0040:17 单元存储键盘状态字节。

| 位  | 表示的键的状态 | 置 1                   |
| :-: | :------------: | :--------------------- |
|  0  |    右 Shift    | 表示按下右 Shift 键    |
|  1  |    左 Shift    | 表示按下左 shift 键    |
|  2  |      Ctrl      | 表示按下 Ctrl 键       |
|  3  |      Alt       | 表示按下 Alt 键        |
|  4  |   ScrollLock   | 表示 Scroll 指示灯亮   |
|  5  |    NumLock     | 表示小键盘输入的是数字 |
|  6  |    CapsLock    | 表示输入大写字母       |
|  7  |     Insert     | 表示处于删除态         |

## 处理过程总结

1. 键盘产生扫描码；
2. 扫描码送入 60H 端口；
3. 引发 9 号中断；
4. CPU 执行 int9 中断例程处理键盘输入。

1，2，3 步都是由硬件系统完成的。

端口和中断机制，是 CPU 进行 I/O 的基础。
